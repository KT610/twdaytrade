<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>台股當沖計算機｜跳動檔數損益試算（做多做空/手續費/證交稅）</title>
  <meta name="description" content="台股當沖計算機：輸入開倉價格、交易張數，選擇做多/做空與個股/ETF，立即看到上下跳動檔位的損益試算，含手續費與證交稅估算。" />
  <link rel="canonical" href="https://twdaytrade.pages.dev/" />

  <!-- ✅ Google AdSense (Site-wide code) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6492672168172091"
     crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#2563eb;

      --pos:#dc2626; /* 正報酬（示意採紅） */
      --neg:#16a34a; /* 負報酬（示意採綠） */

      --warn:#f59e0b;
      --radius:14px;
      --shadow: 0 10px 30px rgba(17,24,39,.06);

      --rowHi: rgba(245,158,11,.18);
      --rowHiLine: rgba(245,158,11,.55);

      --stripe:#fbfbfc;
      --hover:#f6f7fb;

      --adBg:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial;
      background: var(--bg);
      color: var(--text);
      line-height:1.65;
    }

    header{
      max-width:1200px;margin:0 auto;padding:12px 16px 6px;
    }
    .titleRow{
      display:flex;
      align-items:baseline;
      gap:12px;
      flex-wrap:wrap;
    }
    h1{margin:0;font-size:26px;letter-spacing:.2px;line-height:1.2;}
    .titleHint{margin:0;font-size:13px;color:var(--muted);line-height:1.4;}

    main{max-width:1200px;margin:0 auto;padding:8px 16px 20px;}

    /* ====== AdSense Slot Containers (預留高度避免 CLS) ====== */
    .ad-slot{
      background: var(--adBg);
      border:1px dashed #d1d5db;
      border-radius:14px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
    }
    .ad-slot .ad-inner{ width:100%; }

    #ad-top{ min-height:140px; margin:10px 0 14px; }
    @media (max-width:520px){ #ad-top{ min-height:110px; } }

    #ad-right{
      display:none;
      min-height:600px;
      position: sticky;
      top: 14px;
    }
    @media (min-width:1100px){ #ad-right{ display:flex; } }

    #ad-mobile{
      display:flex;
      min-height:100px;
      margin-top:14px;
    }
    @media (min-width:980px){ #ad-mobile{ display:none; } }

    /* ====== Layout ====== */
    .layout{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }

    .rightArea{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 1100px){
      .rightArea{
        grid-template-columns: 1fr 320px;
        align-items:start;
      }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .card h2{margin:0;font-size:14px;letter-spacing:.2px}
    .sectionTitle{display:flex; align-items:center; gap:10px; margin-bottom:10px;}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(37,99,235,.75);}

    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, select, button{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 3px rgba(37,99,235,.10);
    }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:520px){ .row{grid-template-columns:1fr} }

    .hint{font-size:12px; color:var(--muted); margin-top:6px}
    .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    button{
      cursor:pointer;
      border:1px solid rgba(37,99,235,.35);
      background: rgba(37,99,235,.08);
      font-weight:800;
    }
    button:hover{background: rgba(37,99,235,.12);}
    button.secondary{border:1px solid var(--line); background:#fff; font-weight:800;}
    button.secondary:hover{background:#f9fafb;}

    .tiny{ font-size:11px; color:var(--muted); }
    .selectHelp{margin-top:6px;font-size:11px;color:var(--muted);line-height:1.3}

    .resultCard{ text-align:center; }

    .tableWrap{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    table{ width:100%; border-collapse:collapse; }
    thead th{
      background:#f9fafb;
      color:var(--muted);
      font-weight:900;
      font-size:12px;
      padding:12px 10px;
      border-bottom:1px solid var(--line);
      text-align:center;
      white-space:nowrap;
    }
    tbody td{
      padding:12px 10px;
      border-bottom:1px solid var(--line);
      text-align:center;
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
    }
    tbody tr:nth-child(even){ background: var(--stripe); }
    tbody tr:hover{ background: var(--hover); }
    tbody tr:last-child td{ border-bottom:none; }

    .pos{color:var(--pos)}
    .neg{color:var(--neg)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}

    .centerHi{
      background: var(--rowHi) !important;
      outline:2px solid var(--rowHiLine);
      outline-offset:-2px;
    }
    .showMoreRow{
      text-align:center !important;
      color: var(--accent);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      background:#fff !important;
    }
    .showMoreRow:hover{background:#f3f6ff !important;}

    .note{
      border-left:4px solid rgba(245,158,11,.95);
      padding:10px 12px;
      background: rgba(245,158,11,.08);
      border-radius:12px;
      color:#7c4a03;
      margin-top:12px;
      font-size:13px;
      text-align:left;
    }

    details{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      margin-top:10px;
    }
    summary{cursor:pointer; font-weight:900; font-size:13px}

    /* ====== SEO / Content section ====== */
    .contentGrid{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media (max-width:1100px){ .contentGrid{ grid-template-columns:1fr; } }

    .contentCard h2{
      font-size:16px;
      margin:0 0 8px;
      letter-spacing:.2px;
    }
    .contentCard h3{
      font-size:14px;
      margin:14px 0 6px;
    }
    .contentCard p, .contentCard li{
      font-size:14px;
      color: var(--text);
    }
    .contentCard ul{ padding-left:18px; margin:6px 0 0; }
    .mutedP{ color: var(--muted); font-size:13px; }
    .kbadge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      color: #0f172a;
      background: rgba(37,99,235,.10);
      border: 1px solid rgba(37,99,235,.18);
      margin-right:6px;
    }
    .toc{
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      background:#fff;
    }
    .tocTitle{font-weight:900; font-size:13px; margin:0 0 6px;}
    .toc a{
      display:block;
      color: var(--accent);
      text-decoration:none;
      font-size:13px;
      padding:6px 0;
      border-bottom:1px dashed rgba(229,231,235,.9);
    }
    .toc a:last-child{ border-bottom:none; }
    .toc a:hover{ text-decoration:underline; }

    /* ====== Footer ====== */
    .siteFooter{
      margin-top:18px;
      border-top:1px solid var(--line);
      background:#fff;
    }
    .footerInner{
      max-width:1200px;
      margin:0 auto;
      padding:14px 16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .footerBrand{ font-weight:900; letter-spacing:.2px; font-size:13px; color:var(--text); }
    .footerMeta{ font-size:12px; color:var(--muted); line-height:1.4; margin-top:2px; }
    .footerLinks{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; }
    .footerLinks a{
      font-size:12px; color:var(--muted); text-decoration:none; border-bottom:1px dashed transparent;
    }
    .footerLinks a:hover{ color:var(--text); border-bottom-color:rgba(17,24,39,.25); }
    .footerRight{ font-size:12px; color:var(--muted); }
  </style>
</head>

<body>
<header>
  <div class="titleRow">
    <h1>台股當沖計算機</h1>
    <p class="titleHint">輸入開倉價格與張數，選擇做多/做空與費率，右側顯示上下跳動檔位的損益試算。</p>
  </div>

  <!-- ✅ Top AdSense (Responsive) -->
  <div class="ad-slot" id="ad-top" aria-label="Top Ad">
    <div class="ad-inner">
      <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-6492672168172091"
        data-ad-slot="1234567890"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <!-- Left -->
    <section class="card" aria-labelledby="calcTitle">
      <div class="sectionTitle"><span class="dot"></span><h2 id="calcTitle">參數設定</h2></div>

      <div class="row">
        <div>
          <label for="product">商品類型</label>
          <select id="product">
            <option value="stock">個股（證交稅 0.15%）</option>
            <option value="etf">ETF（證交稅 0.1%）</option>
          </select>
          <div class="selectHelp"><span class="tiny">括號內為常見稅率提示，實際以公告/券商為準。</span></div>
        </div>
        <div>
          <label for="side">方向</label>
          <select id="side">
            <option value="long">做多</option>
            <option value="short">做空</option>
          </select>
        </div>
      </div>

      <label for="entry">開倉價格（元）</label>
      <input id="entry" inputmode="decimal" placeholder="例如 100" />

      <label for="lots">交易數量（張）</label>
      <input id="lots" inputmode="numeric" placeholder="例如 1（=1000股）" />

      <div class="actions">
        <button id="btnCalc">立即計算</button>
        <button class="secondary" id="btnReset" type="button">重設</button>
      </div>

      <!-- 手續費設定：預設展開、放在按鈕下方 -->
      <details open>
        <summary>手續費設定</summary>
        <div class="row" style="margin-top:8px">
          <div>
            <label for="discount">折數（例如 2.8 折）</label>
            <input id="discount" inputmode="decimal" value="2.8" />
            <div class="hint">2.8 折 = 0.28 倍</div>
          </div>
          <div>
            <label for="minFee">最低手續費（每邊，元）</label>
            <input id="minFee" inputmode="numeric" value="20" />
          </div>
        </div>
        <label for="commissionRate">手續費率（%）</label>
        <input id="commissionRate" inputmode="decimal" value="0.1425" />
        <div class="hint">預設 0.1425%（買賣各一次，套用折數與最低門檻）</div>
      </details>

      <div class="note">
        <b>免責聲明：</b>本工具僅供試算參考，不構成投資建議；實際稅費與手續費以券商成交單與交易所公告為準。
      </div>

      <!-- ✅ Mobile AdSense (Responsive) -->
      <div class="ad-slot" id="ad-mobile" aria-label="Mobile Ad">
        <div class="ad-inner">
          <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-6492672168172091"
            data-ad-slot="2345678901"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        </div>
      </div>
    </section>

    <!-- Right -->
    <div class="rightArea">
      <section class="card resultCard" aria-labelledby="resultTitle">
        <div class="sectionTitle" style="justify-content:center">
          <span class="dot"></span><h2 id="resultTitle">跳動損益試算</h2>
        </div>

        <div class="tableWrap">
          <table aria-label="跳動損益表">
            <thead>
              <tr>
                <th>買入價格</th>
                <th>賣出價格</th>
                <th>證交稅</th>
                <th>總手續費</th>
                <th>獲利</th>
                <th>報酬率</th>
              </tr>
            </thead>
            <tbody id="ladderBody">
              <tr><td colspan="6" style="text-align:center;color:var(--muted)">請先輸入左側參數並按「立即計算」。</td></tr>
            </tbody>
          </table>
        </div>

        <details style="margin-top:10px; text-align:left;">
          <summary>股價跳動單位（tick）</summary>
          <div class="hint" style="margin-top:8px">
            常見級距：&lt;10：0.01｜10–&lt;50：0.05｜50–&lt;100：0.1｜100–&lt;500：0.5｜500–&lt;1000：1｜≥1000：5
          </div>
        </details>
      </section>

      <!-- ✅ Right Sticky AdSense (Desktop only) -->
      <aside class="ad-slot" id="ad-right" aria-label="Right Ad">
        <div class="ad-inner">
          <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-6492672168172091"
            data-ad-slot="3456789012"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        </div>
      </aside>
    </div>
  </div>

  <!-- ✅ 原創內容區（可見內容：解決 AdSense「沒有發布商內容」） -->
  <section class="contentGrid" aria-label="台股當沖教學與常見問題">
    <article class="card contentCard">
      <h2 id="guide">台股當沖損益怎麼算？手續費、證交稅與 tick 跳動一次搞懂</h2>
      <p class="mutedP">
        <span class="kbadge">當沖試算</span>
        <span class="kbadge">手續費</span>
        <span class="kbadge">證交稅</span>
        <span class="kbadge">tick 跳動</span>
        這個頁面提供「台股當沖計算機」與教學說明：你輸入開倉價格與張數、選擇做多/做空與費率後，
        右側會列出「上下跳動檔位」的損益試算，並把手續費與證交稅納入估算，方便你快速判斷每跳一檔可能賺/賠多少。
      </p>

      <h3 id="what">1）台股當沖成本包含哪些？</h3>
      <p>
        一般的現股當沖，常見成本主要有兩大類：<b>手續費</b>與<b>證交稅</b>。
        手續費通常是「買入一次 + 賣出一次」各收一筆，常見算法是：成交金額 × 手續費率（例如 0.1425%）× 折數，
        並可能有每筆最低手續費門檻（常見 20 元）。證交稅則依商品類型不同：
        個股常見 0.15%，ETF 常見 0.1%（此處為常見情境提示，實務以公告與券商為準）。
      </p>

      <h3 id="fee">2）手續費怎麼算？為什麼會「不線性」？</h3>
      <p>
        手續費多數與成交金額成比例，但因為存在「最低手續費」門檻，所以在小額成交時會出現不線性的狀況。
        例如：若成交金額 × 0.1425% × 折數算出來只有 8 元，但券商最低手續費為 20 元，
        則實際會以 20 元計。當你的成交金額落在門檻附近時，價格每跳動一點點，費用可能仍然保持 20 元不變，
        也可能跨過門檻後開始跟著成交金額增加，這就是為什麼你會看到每一檔的「總費用」不一定等距。
      </p>

      <h3 id="tax">3）證交稅怎麼算？個股與 ETF 有什麼差？</h3>
      <p>
        證交稅通常以「賣出成交金額」乘上稅率計算，因此當你的平倉價不同，每一檔位的賣出金額會改變，
        證交稅也會跟著小幅波動。個股與 ETF 的稅率常見不同，因此同樣的價格跳動幅度，ETF 的稅負可能略低，
        但仍需搭配手續費門檻與折數一起看，才能更接近真實交易成本。
      </p>

      <h3 id="longshort">4）做多 vs 做空：損益方向怎麼看？</h3>
      <p>
        做多（先買後賣）時，平倉價高於開倉價通常是獲利；做空（先賣後買）則相反，平倉價越低通常越有利。
        本頁右側的試算表會依你選擇的方向自動切換：做多時固定買入價、變動賣出價；做空時固定賣出價、變動買回價。
        無論做多或做空，系統都會把雙邊手續費與賣出端證交稅納入估算，讓你在不同檔位更直覺比較。
      </p>

      <h3 id="tick">5）台股 tick 跳動規則（10 / 50 / 100 / 500 / 1000 關卡）</h3>
      <p>
        台股股價有「跳動單位」規則，不同股價區間 tick 大小不同，常見級距如下：
      </p>
      <ul>
        <li><b>&lt; 10 元</b>：每跳 0.01 元</li>
        <li><b>10 ～ &lt; 50 元</b>：每跳 0.05 元</li>
        <li><b>50 ～ &lt; 100 元</b>：每跳 0.1 元</li>
        <li><b>100 ～ &lt; 500 元</b>：每跳 0.5 元</li>
        <li><b>500 ～ &lt; 1000 元</b>：每跳 1 元</li>
        <li><b>≥ 1000 元</b>：每跳 5 元</li>
      </ul>
      <p>
        例如：100 元附近往上跳動是 0.5 元一檔；往下也會依規則逐檔遞減（本工具已修正上下跳動與關卡切換，避免出現價格跳回去的錯誤）。
        若你測試跨過 100、500、1000 等區間時，每一檔顯示的 tick 會依區間規則自動調整。
      </p>

      <h3 id="faq">6）常見問題（FAQ）</h3>
      <ul>
        <li><b>Q：為什麼我調整開倉價格，右側結果沒有立刻變？</b><br/>A：本工具設計為「按下立即計算才更新」，避免你輸入中途結果一直跳動造成誤判。</li>
        <li><b>Q：顯示更多會怎麼加？</b><br/>A：上方「顯示更多」只增加往上檔位 +10；下方「顯示更多」只增加往下檔位 +10，互不連動。</li>
        <li><b>Q：試算跟券商對帳單可能不同嗎？</b><br/>A：可能。不同券商折數、最低門檻、進位/捨去規則可能不同；本工具以常見估算方式呈現。</li>
      </ul>

      <details open style="margin-top:12px">
        <summary>我該如何使用本計算機？</summary>
        <p style="margin-top:8px">
          ① 選商品類型（個股/ETF）與方向（做多/做空） → ② 輸入開倉價格與張數 → ③ 按「立即計算」查看右側上下 5 檔損益
          → ④ 需要更多檔位時，點表格上/下方的「顯示更多（+10 檔）」。
        </p>
      </details>
    </article>

    <aside class="toc" aria-label="快速導覽">
      <div class="tocTitle">快速導覽</div>
      <a href="#guide">教學總覽</a>
      <a href="#what">當沖成本包含哪些</a>
      <a href="#fee">手續費與最低門檻</a>
      <a href="#tax">證交稅與 ETF 差異</a>
      <a href="#longshort">做多做空差異</a>
      <a href="#tick">tick 跳動規則</a>
      <a href="#faq">FAQ</a>

      <div style="margin-top:12px" class="tiny">
        提醒：本頁內容為一般性資訊整理與試算工具，非投資建議。
      </div>
    </aside>
  </section>
</main>

<!-- ✅ Footer：三頁連結完整 -->
<footer class="siteFooter" aria-label="網站頁尾">
  <div class="footerInner">
    <div class="footerLeft">
      <div class="footerBrand">台股當沖計算機</div>
      <div class="footerMeta">本工具僅供試算參考，不構成投資建議；實際費用以券商成交單為準。</div>
    </div>

    <nav class="footerLinks" aria-label="頁尾連結">
      <a href="./privacy.html">隱私權政策</a>
      <a href="./terms.html">使用條款</a>
      <a href="./about.html">關於我們</a>
    </nav>

    <div class="footerRight">
      © <span id="footerYear"></span>
    </div>
  </div>
</footer>

<script>
  document.getElementById("footerYear").textContent = new Date().getFullYear();
</script>

<script>
  // AdSense 初始化：每個 ins 都 push 一次
  window.addEventListener("load", () => {
    try{
      document.querySelectorAll("ins.adsbygoogle").forEach(() => {
        (adsbygoogle = window.adsbygoogle || []).push({});
      });
    }catch(e){}
  });
</script>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  function formatPriceFromCents(c){
    const sign = c < 0 ? "-" : "";
    c = Math.abs(c);
    const intPart = Math.floor(c / 100);
    const frac = c % 100;
    if(frac === 0) return sign + String(intPart);
    if(frac % 10 === 0) return sign + `${intPart}.${Math.floor(frac/10)}`;
    return sign + `${intPart}.${String(frac).padStart(2,"0")}`;
  }
  function parseNum(v){
    const x = Number(String(v).replace(/,/g,'').trim());
    return Number.isFinite(x) ? x : NaN;
  }
  function fmt0(n){
    if(!Number.isFinite(n)) return "—";
    return n.toLocaleString("zh-TW", {maximumFractionDigits: 0});
  }
  function fmt2(n){
    if(!Number.isFinite(n)) return "—";
    return n.toLocaleString("zh-TW", {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  function toCents(price){ return Math.round(price * 100); }
  function fromCents(cents){ return cents / 100; }

  function tickSizeCents(priceCents){
    if(priceCents < 1000) return 1;      // <10 => 0.01
    if(priceCents < 5000) return 5;      // 10~50 => 0.05
    if(priceCents < 10000) return 10;    // 50~100 => 0.1
    if(priceCents < 50000) return 50;    // 100~500 => 0.5
    if(priceCents < 100000) return 100;  // 500~1000 => 1
    return 500;                          // >=1000 => 5
  }
  function nextTickCents(priceCents){ return priceCents + tickSizeCents(priceCents); }
  function prevTickCents(priceCents){
    const ref = priceCents - 1;
    return priceCents - tickSizeCents(ref);
  }

  function getTaxRate(product){ return product === "etf" ? 0.1 : 0.15; }

  function computePNL({product, entry, exit, lots, discount, minFee, commissionRatePct}){
    const shares = lots * 1000;
    const entryAmt = entry * shares;
    const exitAmt  = exit  * shares;

    const commissionRate = (commissionRatePct / 100);
    const discountMul = discount / 10;

    const feeIn  = Math.max(minFee, Math.floor(entryAmt * commissionRate * discountMul));
    const feeOut = Math.max(minFee, Math.floor(exitAmt  * commissionRate * discountMul));
    const totalFee = feeIn + feeOut;

    const tax = Math.floor(exitAmt * (getTaxRate(product)/100));

    const grossPnL = (exit - entry) * shares;
    const netPnL = grossPnL - totalFee - tax;
    const roi = (netPnL / entryAmt) * 100;

    return { tax, totalFee, netPnL, roi };
  }

  // Snapshot：只有按「立即計算」才更新右側
  const snapshot = {
    has:false,
    product:"stock",
    side:"long",
    entry:0,
    lots:0,
    discount:2.8,
    minFee:20,
    commissionRatePct:0.1425,
    upN:5,
    downN:5
  };

  function readForm(){
    const product = $("product").value;
    const side = $("side").value;
    const entry = parseNum($("entry").value);
    const lots  = parseNum($("lots").value);
    const discount = parseNum($("discount").value);
    const minFee = parseNum($("minFee").value);
    const commissionRatePct = parseNum($("commissionRate").value);

    if([entry, lots, discount, minFee, commissionRatePct].some(x=>!Number.isFinite(x)) || entry<=0 || lots<=0 || discount<=0){
      return { ok:false, msg:"請確認輸入正確（價格/張數/折數需為正）。" };
    }
    return { ok:true, product, side, entry, lots, discount, minFee, commissionRatePct };
  }

  function buildUps(centerCents, n){
    const ups = [];
    let p = centerCents;
    for(let i=1;i<=n;i++){ p = nextTickCents(p); ups.push(p); }
    ups.reverse();
    return ups;
  }
  function buildDowns(centerCents, n){
    const downs = [];
    let p = centerCents;
    for(let i=1;i<=n;i++){ p = prevTickCents(p); downs.push(p); }
    return downs;
  }

  function render(){
    const body = $("ladderBody");
    if(!snapshot.has){
      body.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--muted)">請先輸入左側參數並按「立即計算」。</td></tr>`;
      return;
    }

    const entryC = toCents(snapshot.entry);
    const ups = buildUps(entryC, snapshot.upN);
    const downs = buildDowns(entryC, snapshot.downN);

    function mkRow(buyC, sellC, isCenter){
      const buyP = fromCents(buyC);
      const sellP = fromCents(sellC);

      const r = computePNL({
        product: snapshot.product,
        entry: buyP,
        exit: sellP,
        lots: snapshot.lots,
        discount: snapshot.discount,
        minFee: snapshot.minFee,
        commissionRatePct: snapshot.commissionRatePct
      });

      const cls = r.netPnL >= 0 ? "pos" : "neg";
      const sign = r.netPnL >= 0 ? "+" : "";
      const rcls = r.roi >= 0 ? "pos" : "neg";
      const rsign = r.roi >= 0 ? "+" : "";

      return `
        <tr class="${isCenter ? "centerHi" : ""}">
          <td class="mono">${formatPriceFromCents(buyC)}</td>
          <td class="mono">${formatPriceFromCents(sellC)}</td>
          <td class="mono">${fmt0(r.tax)}</td>
          <td class="mono">${fmt0(r.totalFee)}</td>
          <td class="mono ${cls}">${sign}${fmt0(r.netPnL)}</td>
          <td class="mono ${rcls}">${rsign}${fmt2(r.roi)}%</td>
        </tr>
      `;
    }

    const moreUp = `<tr><td colspan="6" class="showMoreRow" id="moreUp">+ 顯示更多（僅往上 +10 檔）</td></tr>`;
    const moreDown = `<tr><td colspan="6" class="showMoreRow" id="moreDown">+ 顯示更多（僅往下 +10 檔）</td></tr>`;

    let html = moreUp;

    if(snapshot.side === "long"){
      const buyC = entryC;
      ups.forEach(sellC => html += mkRow(buyC, sellC, false));
      html += mkRow(buyC, entryC, true);
      downs.forEach(sellC => html += mkRow(buyC, sellC, false));
    }else{
      const sellC = entryC;
      ups.forEach(buyC => html += mkRow(buyC, sellC, false));
      html += mkRow(entryC, sellC, true);
      downs.forEach(buyC => html += mkRow(buyC, sellC, false));
    }

    html += moreDown;
    body.innerHTML = html;

    const btnUp = document.getElementById("moreUp");
    const btnDown = document.getElementById("moreDown");
    if(btnUp) btnUp.onclick = () => { snapshot.upN += 10; render(); };
    if(btnDown) btnDown.onclick = () => { snapshot.downN += 10; render(); };
  }

  function calc(){
    const form = readForm();
    if(!form.ok){ alert(form.msg); return; }
    snapshot.has = true;
    snapshot.product = form.product;
    snapshot.side = form.side;
    snapshot.entry = form.entry;
    snapshot.lots = form.lots;
    snapshot.discount = form.discount;
    snapshot.minFee = form.minFee;
    snapshot.commissionRatePct = form.commissionRatePct;
    snapshot.upN = 5; snapshot.downN = 5;
    render();
  }

  function reset(){
    $("product").value = "stock";
    $("side").value = "long";
    $("entry").value = "";
    $("lots").value = "";
    $("discount").value = "2.8";
    $("minFee").value = "20";
    $("commissionRate").value = "0.1425";
    snapshot.has = false;
    snapshot.upN = 5; snapshot.downN = 5;
    render();
  }

  $("btnCalc").addEventListener("click", calc);
  $("btnReset").addEventListener("click", reset);

  // Enter 快捷鍵：只有按 Enter 才計算（不會自動跟著 input 變）
  ["entry","lots","product","side","discount","minFee","commissionRate"].forEach(id=>{
    $(id).addEventListener("keydown", (e)=>{ if(e.key==="Enter") calc(); });
  });

  render();
})();
</script>
</body>
</html>
